<!doctype html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta content='chrome=1' http-equiv='X-UA-Compatible'>
    <title>omniauth + Google OAuth2 on Rails</title>
    <link href='/images/bike_favicon.png' rel='icon' type='image/png'>
    <!-- Generated 2014-02-24 22:05:25 +0000-->
    <link href='/stylesheets/styles.css' rel='stylesheet'>
    <link href='/stylesheets/pygment_trac.css' rel='stylesheet'>
    <meta content='width=device-width, initial-scale=1, user-scalable=no' name='viewport'>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class='wrapper'>
      <header>
        <div itemscope='itemscope' itemtype='http://schema.org/Blog'>
          <h1>
            <a href='/'>myitcv:blog</a>
          </h1>
        </div>
        <meta content='schema blog' itemprop='name'>
        <hr>
        <h3>Paul Jolly's blog</h3>
      </header>
      <section>
        
<div itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
  <meta content='blog.myitcv.org.uk/2013/02/19/omniauth-google-oauth2-example' itemprop='url'>
  <h1 itemprop='name'>omniauth + Google OAuth2 on Rails</h1>
  <div class='page_details'>
    <hr class='page_details'>
    <abbr class='pagedate' itemprop='datePublished' title='2013-02-19T00:00:00+00:00'>19 FEB 2013</abbr>
    <span class='author' itemprop='author' itemscope='itemscope' itemtype='http://schema.org/Person'>
      <meta content='https://plus.google.com/105997489348527668257' itemprop='url'>
      <a href='https://plus.google.com/105997489348527668257' rel='author' title='author profile'>
        <span itemprop='name'>Paul Jolly</span>
      </a>
    </span>
    <span class='location'>SAN FRANCISCO</span>
    <span class='tags'>
      <ul class='tags'>
        
        <li class='tags'>CODING</li>
        
        <li class='tags'>RUBY</li>
        
        <li class='tags'>RAILS</li>
        
        <li class='tags'>OAUTH2</li>
        
      </ul>
    </span>
    <hr class='page_details'>
  </div>
  <p><strong>Update 2013-03-10:</strong> modified to use <a href="https://github.com/laserlemon/figaro">figaro</a> instead of rather half-baked
<code>parseconfig</code> approach.<br/>
<strong>Update 2013-03-24:</strong> modified to use <code>ActiveRecord</code> sessions and <code>first_or_initialize</code> for user creation (moving the
logic from the model to the controller)<br/>
<strong>Update 2013-06-20:</strong> I have written a <a href="/2013/06/20/using-google-apis-in-rails-apps-with-oauth-2.0.html">follow-up
post</a> which provides a better example of OAuth2,
persistance of OAuth credentials and using those credentials with Google APIs</p>

<hr/>

<p>All of the code for the following example is <a href="https://github.com/myitcv/omniauth-google-oauth2-example">on GitHub</a> .
However for the sake of readability I have left out the init of a git repository in the description that follows...
clearly this is an important step</p>

<p>First fire up a terminal and change to your development directory:</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash">rails new omniauth-google-oauth2-example
<span class="nb">cd </span>omniauth-google-oauth2-example
</code></pre></div>
<p>You will at this point be in the directory Rails just created.</p>

<p>Now edit the <code>Gemfile</code> to include the following <a href="http://haml.info/">Haml</a> and
<a href="https://github.com/laserlemon/figaro">figaro</a> support:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="c1"># /Gemfile</span>
<span class="c1"># ...</span>

<span class="n">gem</span> <span class="s1">&#39;haml&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;haml-rails&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;figaro&#39;</span>

<span class="c1"># ...</span>
</code></pre></div>
<p>Let&#39;s now ensure the requisite gems are installed:</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash">bundle install
</code></pre></div>
<p>Now let&#39;s ensure the figaro setup is in place:</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash">rails generate figaro:install
</code></pre></div>
<p>Time to tidy up a couple of files that we no longer need (for this simple example at least). Back to the terminal:</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash">rm app/views/layouts/application.html.erb
rm public/index.html
</code></pre></div>
<p>Now to generate our first controller:</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash">rails generate controller home index
</code></pre></div>
<p>Now edit the routes to set the root path:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="c1"># /config/routes.rb</span>

<span class="no">OmniauthGoogleOauth2Example</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s2">&quot;home/index&quot;</span>
  <span class="n">root</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="s1">&#39;home#index&#39;</span>
<span class="k">end</span>
</code></pre></div>
<p>We should at this point be able to fire up the <code>rails server</code> and see the default view we just created:</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash">rails server
</code></pre></div>
<p>If your configure is like mine, head to <a href="http://localhost:3000">http://localhost:3000</a> to see the results. It should
look something like:</p>

<hr/>

<p><img src="/images/2013-02-19-first-run-of-rails.png" alt="">
<hr/></p>

<p>So now we have a working Rails setup that uses Haml as the template language. Before we go too far, let&#39;s setup the
session handling and user model:</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash">rails generate session_migration
rails generate controller sessions
rails generate model user provider:string <span class="se">\</span>
  uid:string <span class="se">\</span>
  name:string <span class="se">\</span>
  refresh_token:string <span class="se">\</span>
  access_token:string <span class="se">\</span>
  expires:timestamp
rake db:migrate
</code></pre></div>
<p>Let&#39;s configure rails to use the ActiveRecord session handling:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="c1"># config/initializers/session_store.rb</span>

<span class="c1"># replace the contents of the entire file</span>
<span class="no">OmniauthGoogleOauth2Example</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">session_store</span> <span class="ss">:active_record_store</span>
</code></pre></div>
<p>We will add the routes to the session handling later (it will actually be a callback from our Google auth provider). So
for now let&#39;s fill out the session controller and the user model:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="c1"># /app/controllers/sessions_controller.rb</span>

<span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">auth</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s2">&quot;omniauth.auth&quot;</span><span class="o">]</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="n">auth</span><span class="o">[</span><span class="s2">&quot;provider&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:uid</span> <span class="o">=&gt;</span> <span class="n">auth</span><span class="o">[</span><span class="s2">&quot;uid&quot;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">first_or_initialize</span><span class="p">(</span>
      <span class="ss">:refresh_token</span> <span class="o">=&gt;</span> <span class="n">auth</span><span class="o">[</span><span class="s2">&quot;credentials&quot;</span><span class="o">][</span><span class="s2">&quot;refresh_token&quot;</span><span class="o">]</span><span class="p">,</span>
      <span class="ss">:access_token</span> <span class="o">=&gt;</span> <span class="n">auth</span><span class="o">[</span><span class="s2">&quot;credentials&quot;</span><span class="o">][</span><span class="s2">&quot;token&quot;</span><span class="o">]</span><span class="p">,</span>
      <span class="ss">:expires</span> <span class="o">=&gt;</span> <span class="n">auth</span><span class="o">[</span><span class="s2">&quot;credentials&quot;</span><span class="o">][</span><span class="s2">&quot;expires_at&quot;</span><span class="o">]</span><span class="p">,</span>
      <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="n">auth</span><span class="o">[</span><span class="s2">&quot;info&quot;</span><span class="o">][</span><span class="s2">&quot;name&quot;</span><span class="o">]</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:return_to</span><span class="o">]</span> <span class="o">||</span> <span class="n">root_path</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:return_to</span><span class="o">]</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">root_path</span> <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">eql?</span><span class="p">(</span><span class="s1">&#39;/logout&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
      <span class="n">notice</span> <span class="o">=</span> <span class="s2">&quot;Signed in!&quot;</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&quot;URL to redirect to: </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="n">redirect_to</span> <span class="n">url</span><span class="p">,</span> <span class="ss">:notice</span> <span class="o">=&gt;</span> <span class="n">notice</span>
    <span class="k">else</span>
      <span class="k">raise</span> <span class="s2">&quot;Failed to login&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span><span class="p">,</span> <span class="ss">:notice</span> <span class="o">=&gt;</span> <span class="s2">&quot;Signed out!&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="c1"># /app/models/user.rb</span>

<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:provider</span><span class="p">,</span> <span class="ss">:uid</span><span class="p">,</span> <span class="ss">:refresh_token</span><span class="p">,</span> <span class="ss">:access_token</span><span class="p">,</span> <span class="ss">:expires</span>

  <span class="n">validates_uniqueness_of</span> <span class="ss">:uid</span><span class="p">,</span> <span class="ss">:scope</span> <span class="o">=&gt;</span> <span class="ss">:provider</span>
<span class="k">end</span>
</code></pre></div>
<p>OK, let&#39;s include the Google omniauth piece now. First, back to edit the <code>Gemfile</code> to include:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="c1"># /Gemfile</span>
<span class="c1"># ...</span>

<span class="n">gem</span> <span class="s1">&#39;omniauth-google-oauth2&#39;</span>

<span class="c1"># ...</span>
</code></pre></div>
<p>Again, let&#39;s ensure the gems are installed:</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash">bundle install
</code></pre></div>
<p>Now you need to <a href="https://code.google.com/apis/console/">head over to the Google apis console</a> and create an API Project.
<a href="https://developers.google.com/console/help/#creatingdeletingprojects">Create a project</a> then you need to <a href="https://developers.google.com/console/help/#generatingoauth2">generate and
OAuth 2.0 client ID</a> :</p>

<hr/>

<p><img src="/images/2013-02-19-google-oauth2.png" alt="">
<hr/></p>

<p>The settings for this basic test are:</p>

<table><thead>
<tr>
<th>Setting</th>
<th>Value</th>
</tr>
</thead><tbody>
<tr>
<td>Product name:</td>
<td>www.myitcv.org.uk</td>
</tr>
<tr>
<td>Application type:</td>
<td>Web Application</td>
</tr>
<tr>
<td>Your site or hostname:</td>
<td>`<code>http://localhost:3000/auth/google_login/callback</code></td>
</tr>
</tbody></table>

<p>You should now be presented with a page that includes a <em>Client ID</em> and <em>Client secret</em>. We need to populate these in
our <code>config/application.yml</code> file:</p>
<div class="highlight"><pre><code class="yaml language-yaml" data-lang="yaml"><span class="c1"># config/application.yml</span>

<span class="l-Scalar-Plain">OAUTH_CLIENT_ID</span><span class="p-Indicator">:</span> <span class="s">&quot;&lt;CLIENT_ID&gt;&quot;</span>
<span class="l-Scalar-Plain">OAUTH_CLIENT_SECRET</span><span class="p-Indicator">:</span> <span class="s">&quot;&lt;CLIENT_SECRET&gt;&quot;</span>
<span class="l-Scalar-Plain">APPLICATION_CONFIG_SECRET_TOKEN</span><span class="p-Indicator">:</span> <span class="s">&quot;&lt;A</span><span class="nv"> </span><span class="s">LONG</span><span class="nv"> </span><span class="s">SECRET&gt;&quot;</span>
</code></pre></div>
<p>(In the commited files I have also include a &#39;secret&#39; for the application&#39;s secret token. Check out
<a href="https://github.com/myitcv/omniauth-google-oauth2-example/blob/master/config/initializers/secret_token.rb">config/initializers/secret_token.rb</a>
for the code)</p>

<p>Now create the following file:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="c1"># /config/initializers/omniauth.rb</span>

<span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="no">OmniAuth</span><span class="o">::</span><span class="no">Builder</span> <span class="k">do</span>
  <span class="n">provider</span> <span class="ss">:google_oauth2</span><span class="p">,</span>
    <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;OAUTH_CLIENT_ID&#39;</span><span class="o">]</span><span class="p">,</span>
    <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;OAUTH_CLIENT_SECRET&#39;</span><span class="o">]</span><span class="p">,</span>
    <span class="p">{</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;google_login&quot;</span><span class="p">,</span> <span class="n">approval_prompt</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
<p>Couple of things to notice here. Firstly, we have named this provider; this is good practice in case you want to add
other Google-based authorisation providers to your site (for example there is a sub section of your site that requires
access to a user&#39;s calendar).</p>

<p>Secondly, <em>and this really caught me out</em>, we set the <code>approval_prompt</code> to <code>&#39;&#39;</code>. This is not
particularly well document anywhere that I could find. Basically, if you don&#39;t set this to blank, the user will be
prompted to permission your web application every time they access your site. Why? Because the default (unless you
override to blank) is a setting of <code>&#39;force&#39;</code>. This took me far too long to work out.</p>

<p>Now lets setup the routes for omniauth:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="c1"># /config/routes.rb</span>

<span class="no">OmniauthGoogleOauth2Example</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s2">&quot;home/index&quot;</span>
  <span class="n">root</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="s1">&#39;home#index&#39;</span>
  <span class="n">match</span> <span class="s2">&quot;/auth/google_login/callback&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;sessions#create&quot;</span>
  <span class="n">match</span> <span class="s2">&quot;/signout&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;sessions#destroy&quot;</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:signout</span>
<span class="k">end</span>
</code></pre></div>
<p>Getting there. Now let&#39;s put in place an improved front page that presents some simple links allowing us to login/logout
etc.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="c1"># /app/views/home/index.html.haml</span>

<span class="o">%</span><span class="n">h1</span> <span class="no">Home</span>
<span class="o">-</span> <span class="k">if</span> <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span>
  <span class="o">%</span><span class="n">h2</span> <span class="o">***</span> <span class="c1">#{flash[:notice]} ***</span>
<span class="o">-</span> <span class="k">if</span> <span class="n">current_user</span>
  <span class="o">%</span><span class="nb">p</span> <span class="no">Welcome</span> <span class="c1">#{current_user.name}!</span>
  <span class="o">%</span><span class="nb">p</span>
    <span class="o">=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign Out&quot;</span><span class="p">,</span> <span class="n">signout_path</span>
<span class="o">-</span> <span class="k">else</span>
  <span class="o">%</span><span class="nb">p</span>
    <span class="o">=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in with Google google_login&quot;</span><span class="p">,</span> <span class="s2">&quot;/auth/google_login&quot;</span>
    <span class="o">=</span> <span class="n">link_to</span> <span class="s2">&quot;Auth with Google google_auth&quot;</span><span class="p">,</span> <span class="s2">&quot;/auth/google_auth&quot;</span>
</code></pre></div>
<p>You will see we are referencing a helper function here that we need to define:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="c1"># /app/controllers/application_controller.rb</span>

<span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">protect_from_forgery</span>

  <span class="n">helper_method</span> <span class="ss">:current_user</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span> <span class="k">if</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>
<hr>
<h4>Related Posts</h4>
<ul class='posts'>
  
  <li>
    <span>25 Jun 2013</span>
    &raquo;
    <a href='/2013/06/25/finding-low-use-contacts-google-contacts-api-and-gmail-imap-meet.html'>Finding 'low use' contacts - Google Contacts API and GMail IMAP meet</a>
  </li>
  
  <li>
    <span>20 Jun 2013</span>
    &raquo;
    <a href='/2013/06/20/using-google-apis-in-rails-apps-with-oauth-2.0.html'>Using Google APIs in Rails apps with OAuth 2.0</a>
  </li>
  
  <li>
    <span>12 Jun 2013</span>
    &raquo;
    <a href='/2013/06/12/virtualbox-ubuntu-guest-dns-lookups-failing-after-mac-host-wake-from-sleep.html'>VirtualBox Ubuntu guest DNS lookups failing after Mac host wake from sleep</a>
  </li>
  
</ul>

<hr>
<div id='disqus_thread'></div>
<script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  
  var disqus_shortname = 'myitcv'; // required: replace example with your forum shortname
  var disqus_identifier = 'http://blog.myitcv.org.uk/2013/02/19/omniauth-google-oauth2-example';
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>
  Please enable JavaScript to view the
  <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a>
</noscript>
<a class='dsq-brlink' href='http://disqus.com'>
  comments powered by
  <span class='logo-disqus'>Disqus</span>
</a>


      </section>
      <footer>
        <p>
          <a href='http://www.myitcv.org.uk'>http://www.myitcv.org.uk</a>
          <br>
          <a href='mailto:paul@myitcv.org.uk'>paul@myitcv.org.uk</a>
        </p>
        <p>
          <a class='twitter icon' href='http://twitter.com/P__A__J'>Twitter</a>
          <a class='google icon' href='https://plus.google.com/u/0/105997489348527668257' rel='publisher'>Google</a>
          <a class='skype icon' href='skype:myitcv'>Skype</a>
          <a class='linkedin icon' href='http://uk.linkedin.com/in/pauljolly/'>LinkedIn</a>
          <a class='github icon' href='https://github.com/myitcv'>github</a>
          <br>
        </p>
        <p>
          <small>
            Theme by
            <a href='https://github.com/orderedlist'>orderedlist</a>
          </small>
        </p>
      </footer>
    </div>
    <script src='/javascripts/scale.fix.js'></script>
    <script>
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-38400814-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
