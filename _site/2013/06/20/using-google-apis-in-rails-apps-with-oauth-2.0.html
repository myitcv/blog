<!doctype html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta content='chrome=1' http-equiv='X-UA-Compatible'>
    <title>Using Google APIs in Rails apps with OAuth 2.0</title>
    <link href='/images/bike_favicon.png' rel='icon' type='image/png'>
    <!-- Generated 2014-02-24 22:05:25 +0000-->
    <link href='/stylesheets/styles.css' rel='stylesheet'>
    <link href='/stylesheets/pygment_trac.css' rel='stylesheet'>
    <meta content='width=device-width, initial-scale=1, user-scalable=no' name='viewport'>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class='wrapper'>
      <header>
        <div itemscope='itemscope' itemtype='http://schema.org/Blog'>
          <h1>
            <a href='/'>myitcv:blog</a>
          </h1>
        </div>
        <meta content='schema blog' itemprop='name'>
        <hr>
        <h3>Paul Jolly's blog</h3>
      </header>
      <section>
        
<div itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
  <meta content='blog.myitcv.org.uk/2013/06/20/using-google-apis-in-rails-apps-with-oauth-2.0' itemprop='url'>
  <h1 itemprop='name'>Using Google APIs in Rails apps with OAuth 2.0</h1>
  <div class='page_details'>
    <hr class='page_details'>
    <abbr class='pagedate' itemprop='datePublished' title='2013-06-20T00:00:00+01:00'>20 JUN 2013</abbr>
    <span class='author' itemprop='author' itemscope='itemscope' itemtype='http://schema.org/Person'>
      <meta content='https://plus.google.com/105997489348527668257' itemprop='url'>
      <a href='https://plus.google.com/105997489348527668257' rel='author' title='author profile'>
        <span itemprop='name'>Paul Jolly</span>
      </a>
    </span>
    <span class='location'>LONDON</span>
    <span class='tags'>
      <ul class='tags'>
        
        <li class='tags'>CODING</li>
        
        <li class='tags'>RUBY</li>
        
        <li class='tags'>RAILS</li>
        
        <li class='tags'>OAUTH2</li>
        
        <li class='tags'>GOOGLE</li>
        
      </ul>
    </span>
    <hr class='page_details'>
  </div>
  <p><a href="/2013/02/19/omniauth-google-oauth2-example.html">Back in February</a> I wrote a blog post about omniauth + Google OAuth2
on Rails. The app desribed in the post stopped short of doing anything useful once the OAuth2 credentials had been
obtained. The article you are reading revises my current thinking on how best to use OAuth2 + Google in a Rails app, but
importantly goes the extra mile of offering some code that pulls data from the <a href="https://developers.google.com/google-apps/calendar/">Google Calendar
API</a></p>

<p>Firstly credits. I bumped into <a href="http://blog.baugues.com/google-calendar-api-oauth2-and-ruby-on-rails">this article</a> by
Greg Baugues which inspired me to step outside the world of <a href="https://github.com/intridea/omniauth"><code>omniauth</code></a> and
explore <a href="https://github.com/google/google-api-ruby-client"><code>google-api-client</code></a> and
<a href="https://github.com/google/signet"><code>signet</code></a></p>

<p><code>google-api-client</code> is a gem that &quot;makes it trivial to discover and access supported APIs&quot; - e.g. the Calendar API.
<code>signet</code> is an OAuth 1.0 / OAuth 2.0 implementation by the same guys behind the <code>google-api-client</code> gem. Combined they
allow you to write a Ruby app that uses OAuth2 to pull data from Google APIs.</p>

<p>The important thing to note here is that <code>google-api-client</code> depends on <code>signet</code> and uses it extensively for
authentication flows etc. Therefore any Rails app using <code>omniauth</code> for authentication would need (at least in part) to
use <code>signet</code> before getting down to the Google API bit. So, I hear you ask, why bother with <code>omniauth</code> at all? Good
question.</p>

<p>My usage of <code>omniauth</code> (not the gem itself) always seemed a bit flawed. 99% of the time I&#39;m looking for an OAuth2
authentication gem that will handle not only the OAuth dance but also the persistence of the retrieved <code>access_token</code>
(and optionally <code>refresh_token</code>) to some store (generally <code>ActiveRecord</code>).</p>

<p>Having concluded this was never going to be the responsibility of an OAuth gem (<code>signet</code>, <code>omniauth</code> or otherwise) I set
about writing <a href="https://github.com/myitcv/signet-rails"><code>signet-rails</code></a> , a gem that would make it easy to incorporate an
OAuth2 flow into a Rails app but also handle the persistence aspect I so longed for.</p>

<h2>signet-rails</h2>

<p><code>signet-rails</code> is in its early days but will hopefully blossom into a transparent OAuth2 handler within Rails apps,
sitting neatly atop <code>signet</code>. <a href="https://github.com/myitcv/signet-rails/issues">Comments gratefully received</a> over on
GitHub on progress to date.</p>

<h2>Example Rails app</h2>

<p>In pulling together what is a <em>very</em> early version of this gem, I have also create a sample app.
<a href="https://github.com/myitcv/test-signet-rails"><code>test-signet-rails</code></a> demonstrates how to use <code>signet-rails</code> and then goes
on to show how to connect to the Google Calendar API and retrieve a list of the user&#39;s calendars.</p>

<h2>Refreshing access tokens</h2>

<p>Another question that vexed me for some time was how and when to refresh expired access tokens. <code>omniauth</code> does not
claim to make any provision for this functionality. Indeed in response to a question on the matter,
<a href="https://github.com/zquestz">`zquestz</a> (who maintains the <code>omniauth</code> Google OAuth2 implementation amongst other things)
<a href="https://github.com/intridea/omniauth-oauth2/issues/40#issuecomment-19335998">directed me towards `google-api-client@</a></p>

<p>With <code>signet-rails</code>, refreshing of access tokens is indeed left to <code>google-api-client</code>. If a user&#39;s <code>access_token</code> is
refreshed in the course of a request, the updated <code>access_token</code> is persisted for use in later requests.</p>

<h2>Conclusion</h2>

<p>Whilst very much a work in progress, <code>signet-rails</code> provides an easy way to integrate OAuth2 into a Rails app, persist
OAuth2 credentials and then uses those credentials to access Google APIs. It should be noted the gem itself is not
specific to Google (although <code>v0.0.4</code> at the time of writing has some hard codings to Google end points) so
theoretically it could be used for any OAuth2 server, and the credentials then used with any OAuth2 driven service.</p>

</div>
<hr>
<h4>Related Posts</h4>
<ul class='posts'>
  
  <li>
    <span>25 Jun 2013</span>
    &raquo;
    <a href='/2013/06/25/finding-low-use-contacts-google-contacts-api-and-gmail-imap-meet.html'>Finding 'low use' contacts - Google Contacts API and GMail IMAP meet</a>
  </li>
  
  <li>
    <span>12 Jun 2013</span>
    &raquo;
    <a href='/2013/06/12/virtualbox-ubuntu-guest-dns-lookups-failing-after-mac-host-wake-from-sleep.html'>VirtualBox Ubuntu guest DNS lookups failing after Mac host wake from sleep</a>
  </li>
  
  <li>
    <span>01 Jun 2013</span>
    &raquo;
    <a href='/2013/06/01/listing-the-files-google-drive-is-actively-syncing.html'>Showing/listing the files Google Drive is actively syncing</a>
  </li>
  
</ul>

<hr>
<div id='disqus_thread'></div>
<script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  
  var disqus_shortname = 'myitcv'; // required: replace example with your forum shortname
  var disqus_identifier = 'http://blog.myitcv.org.uk/2013/06/20/using-google-apis-in-rails-apps-with-oauth-2.0';
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>
  Please enable JavaScript to view the
  <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a>
</noscript>
<a class='dsq-brlink' href='http://disqus.com'>
  comments powered by
  <span class='logo-disqus'>Disqus</span>
</a>


      </section>
      <footer>
        <p>
          <a href='http://www.myitcv.org.uk'>http://www.myitcv.org.uk</a>
          <br>
          <a href='mailto:paul@myitcv.org.uk'>paul@myitcv.org.uk</a>
        </p>
        <p>
          <a class='twitter icon' href='http://twitter.com/P__A__J'>Twitter</a>
          <a class='google icon' href='https://plus.google.com/u/0/105997489348527668257' rel='publisher'>Google</a>
          <a class='skype icon' href='skype:myitcv'>Skype</a>
          <a class='linkedin icon' href='http://uk.linkedin.com/in/pauljolly/'>LinkedIn</a>
          <a class='github icon' href='https://github.com/myitcv'>github</a>
          <br>
        </p>
        <p>
          <small>
            Theme by
            <a href='https://github.com/orderedlist'>orderedlist</a>
          </small>
        </p>
      </footer>
    </div>
    <script src='/javascripts/scale.fix.js'></script>
    <script>
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-38400814-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
