<!doctype html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta content='chrome=1' http-equiv='X-UA-Compatible'>
    <title>Finding 'low use' contacts - Google Contacts API and GMail IMAP meet</title>
    <link href='/images/bike_favicon.png' rel='icon' type='image/png'>
    <!-- Generated 2014-02-24 16:38:29 +0000-->
    <link href='/stylesheets/styles.css' rel='stylesheet'>
    <link href='/stylesheets/pygment_trac.css' rel='stylesheet'>
    <meta content='width=device-width, initial-scale=1, user-scalable=no' name='viewport'>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class='wrapper'>
      <header>
        <div itemscope='itemscope' itemtype='http://schema.org/Blog'>
          <h1>
            <a href='/'>myitcv:blog</a>
          </h1>
        </div>
        <meta content='schema blog' itemprop='name'>
        <hr>
        <h3>Paul Jolly's blog</h3>
      </header>
      <section>
        
<div itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
  <meta content='blog.myitcv.org.uk/2013/06/25/finding-low-use-contacts-google-contacts-api-and-gmail-imap-meet' itemprop='url'>
  <h1 itemprop='name'>Finding 'low use' contacts - Google Contacts API and GMail IMAP meet</h1>
  <div class='page_details'>
    <hr class='page_details'>
    <abbr class='pagedate' itemprop='datePublished' title='2013-06-25T00:00:00+01:00'>25 JUN 2013</abbr>
    <span class='author' itemprop='author' itemscope='itemscope' itemtype='http://schema.org/Person'>
      <meta content='https://plus.google.com/105997489348527668257' itemprop='url'>
      <a href='https://plus.google.com/105997489348527668257' rel='author' title='author profile'>
        <span itemprop='name'>Paul Jolly</span>
      </a>
    </span>
    <span class='location'>LONDON</span>
    <span class='tags'>
      <ul class='tags'>
        
        <li class='tags'>CODING</li>
        
        <li class='tags'>RUBY</li>
        
        <li class='tags'>RAILS</li>
        
        <li class='tags'>OAUTH2</li>
        
        <li class='tags'>GOOGLE</li>
        
        <li class='tags'>API</li>
        
        <li class='tags'>IMAP</li>
        
        <li class='tags'>CONTACTS</li>
        
      </ul>
    </span>
    <hr class='page_details'>
  </div>
  <p>My address book contacts a number of contacts I bulk imported from the business school (<a href="http://www.london.edu/">LBS</a>
and <a href="http://www.haas.berkeley.edu/">Haas</a> ). Given the size of the years, there are ~1000 people I have therefore never
properly spoken to. Quite a thought.</p>

<p>But this has left my address book rather cluttered. And as fast as my <a href="http://www.samsung.com/uk/consumer/mobile-devices/smartphones/android/GT-I9300MBDBTU">Samsung Galaxy
S3</a> is, it struggles with 2500
contacts. Screen switching is slow, particularly when accessing the &#39;Contacts&#39; app.</p>

<p>So I decided to have a purge. An automated purge. I wanted to find contacts where:</p>

<ul>
<li>I had no phone number for the individual</li>
<li>I had only one email address for the individual, and that email address was a <code>london.edu</code> or <code>mba.berkeley.edu</code> address</li>
<li>They had sent me (not a list) zero emails</li>
</ul>

<p>Conditions 1 and 2 could be solved by inspecting the contacts alone. The third condition makes this task non-trivial,
because it requires an email search on a contact-by-contact basis.</p>

<p>Building on my recently developed <a href="https://github.com/myitcv/signet-rails"><code>signet-rails</code></a> I decided to give this a go.
This type of task is not well suited to a web application, but it certainly wouldn&#39;t harm to exercise <code>signet-rails</code> a
bit more.</p>

<p>Below is the controller (again, a Rails app is really not the place for this kind of utility app) code that achieves
this. Once all the contacts have been found that meet the conditions above, each contact is placed into a group called
&#39;Not Used&#39;. This would allow me to perform once last quick visual check in my browser to ensure I wasn&#39;t deleting any
legitimate contacts.</p>

<p>The code itself is not the most efficient but demonstrates a couple of interesting/important features:</p>

<ul>
<li>Use of <a href="https://developers.google.com/gmail/xoauth2_protocol">SASL XOAUTH2</a> authentication with <code>Net::IMAP</code> for
password-less access</li>
<li>Another example usages of <code>signet-rails</code>; we rely heavily on the automatic persistence of OAuth2 credentials here...as
well as automatic refresh of access tokens</li>
<li>Use of the <a href="https://developers.google.com/google-apps/contacts/v3/">Google Contacts API</a> outside of the <a href="https://developers.google.com/gdata/">Google Data
APIs SDKs</a></li>
<li>Use of <a href="http://nokogiri.org/">Nokogiri</a> to parse the response from the Google Contacts API</li>
<li>Updating contacts, again outside of the GData SDKs</li>
</ul>

<h2>Conclusion</h2>

<p>The Google Contacts API is not, in its current form, at all usable. In fact it&#39;s horrid. One imagines they have a <a href="https://developers.google.com/apis-explorer/#p/">new
style API</a> cooking in the background, but for now we are stuck with an
Atom-based monster.</p>

<p>The code is not difficult, but the lack of good documentation for the Google Contacts API specifically made progress
slow. That and the very unhelpful error messages every now and then: &quot;Something went wrong - that&#39;s all we know&quot;</p>

<p>Still: mission accomplished. My phone is usable again!</p>

<h2>The code</h2>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;net/imap&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;nokogiri&#39;</span>

<span class="k">class</span> <span class="nc">XOAUTH2Authenticator</span>
  <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">challenge</span><span class="p">)</span>
    <span class="s2">&quot;user=</span><span class="si">#{</span><span class="sb">`user}\u0001auth=Bearer </span><span class="si">#{</span><span class="sb">`access_token}\u0001\u0001&quot;</span>
<span class="sb">  end</span>

<span class="sb">  def initialize(user, access_token)</span>
<span class="sb">    @user = user</span>
<span class="sb">    @access_token = access_token</span>
<span class="sb">  end</span>
<span class="sb">end</span>

<span class="sb">Net::IMAP.add_authenticator &quot;XOAUTH2&quot;, XOAUTH2Authenticator</span>

<span class="sb">class HomeController &lt; ApplicationController</span>
<span class="sb">  skip_before_filter :require_login, only: [:index]</span>
<span class="sb">  skip_authorization_check :only =&gt; [:index]</span>

<span class="sb">  def index</span>
<span class="sb">    if logged_in?</span>
<span class="sb">      auth = Signet::Rails::Factory.create_from_env :google, request.env</span>
<span class="sb">      client = Google::APIClient.new</span>
<span class="sb">      client.authorization = auth</span>

<span class="sb">      auth.refresh!</span>

<span class="sb">      # ***************************</span>
<span class="sb">      # get contacts - gd:etag will not be returned unless you specify the GData-Version header</span>
<span class="sb">      contacts_feed = auth.fetch_protected_resource({</span>
<span class="sb">    uri: &quot;https://www.google.com/m8/feeds/contacts/</span><span class="si">#{</span><span class="n">current_user</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="sb">/full?max-results=10000&quot;,</span>
<span class="sb">    headers: {&#39;GData-Version&#39; =&gt; &#39;3.0&#39;}</span>
<span class="sb">      })</span>
<span class="sb">      contacts = Nokogiri::XML(contacts_feed.body.to_s)</span>

<span class="sb">      # find &#39;low use&#39; contacts; 0 phone numbers, email address either `</span><span class="n">london</span><span class="o">.</span><span class="n">edu</span> <span class="ow">or</span> <span class="sb">`mba.berkeley.edu</span>
<span class="sb">      low_use = contacts.xpath(&quot;//xmlns:entry[count(gd:phoneNumber) = 0 and count(gd:email) = 1 and (contains(gd:email/`</span><span class="n">address</span><span class="p">,</span> <span class="s1">&#39;mba.berkeley.edu&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">contains</span><span class="p">(</span><span class="ss">gd</span><span class="p">:</span><span class="n">email</span><span class="o">/</span><span class="sb">`address, &#39;london.edu&#39;))]&quot;)</span>

<span class="sb">      # ***************************</span>
<span class="sb">      # setup imap</span>
<span class="sb">      imap = Net::IMAP.new(&#39;imap.gmail.com&#39;, {ssl: true})</span>
<span class="sb">      imap.authenticate(&#39;XOAUTH2&#39;, current_user.email, auth.access_token)</span>
<span class="sb">      all_mail = imap.select(&#39;[Google Mail]/All Mail&#39;)</span>

<span class="sb">      # iterate through each low_use contact and find emails from them to me</span>
<span class="sb">      for c in low_use do</span>
<span class="sb">    # there will only be one email address.... based on the xpath above</span>
<span class="sb">    email = c.xpath(&#39;gd:email&#39;).first[&#39;address&#39;]</span>
<span class="sb">    next if email.nil?</span>
<span class="sb">    matches = imap.search([&#39;FROM&#39;, email, &#39;TO&#39;, &#39;me&#39;])</span>

<span class="sb">    # if there are no emails from this &#39;low use&#39; contact...</span>
<span class="sb">    if matches.count == 0</span>
<span class="sb">      group = Nokogiri::XML::Node.new &#39;groupMembershipInfo&#39;, contacts</span>

<span class="sb">      # this is a bit bizarre - is this a nokogiri bug? Need to use explicit setter?</span>
<span class="sb">      group.namespace = group.add_namespace(&#39;gContact&#39;, &#39;http://schemas.google.com/contact/2008&#39;)</span>
<span class="sb">      group[&#39;deleted&#39;] = false</span>

<span class="sb">      # this is the group where I want to collect these contacts</span>
<span class="sb">      group[&#39;href&#39;] = &#39;http://www.google.com/m8/feeds/groups/paul%40myitcv.org.uk/base/3fa06f7f88078654&#39;</span>
<span class="sb">      c.add_child(group)</span>

<span class="sb">      # for some reason, the spec suggests these namespaces aren&#39;t required, but missing them off causes errors referring to namespace binding</span>
<span class="sb">      c[&#39;xmlns:gd&#39;] = &#39;http://schemas.google.com/g/2005&#39;</span>
<span class="sb">      c[&#39;xmlns&#39;] = &#39;http://www.w3.org/2005/Atom&#39;</span>
<span class="sb">      c[&#39;xmlns:gContact&#39;] = &#39;http://schemas.google.com/contact/2008&#39;</span>

<span class="sb">      # again, bizarre that the ID URL is not the exact URL we should use for updates</span>
<span class="sb">      update_uri = c.xpath(&#39;xmlns:id/text()&#39;).to_s.sub(&#39;/base/&#39;,&#39;/full/&#39;).sub(&#39;http:&#39;,&#39;https:&#39;)</span>

<span class="sb">      # this will help ensure we only update the version we were given</span>
<span class="sb">      etag = c.xpath(&#39;@gd:etag&#39;).to_s</span>

<span class="sb">      # PUT an update; note the special headers...</span>
<span class="sb">      updated_contact = auth.fetch_protected_resource({</span>
<span class="sb">        uri: update_uri,</span>
<span class="sb">        method: :put,</span>
<span class="sb">        body: c.to_s,</span>
<span class="sb">        headers: {</span>
<span class="sb">          &#39;If-Match&#39; =&gt; etag,</span>
<span class="sb">          &#39;GData-Version&#39; =&gt; &#39;3.0&#39;,</span>
<span class="sb">          &#39;Content-type&#39; =&gt; &#39;application/atom+xml&#39;,</span>
<span class="sb">      }})</span>
<span class="sb">    end</span>
<span class="sb">      end</span>
<span class="sb">    end</span>
<span class="sb">  end</span>
<span class="sb">end</span>
</code></pre></div>
</div>
<hr>
<h4>Related Posts</h4>
<ul class='posts'>
  
  <li>
    <span>20 Jun 2013</span>
    &raquo;
    <a href='/2013/06/20/using-google-apis-in-rails-apps-with-oauth-2.0.html'>Using Google APIs in Rails apps with OAuth 2.0</a>
  </li>
  
  <li>
    <span>12 Jun 2013</span>
    &raquo;
    <a href='/2013/06/12/virtualbox-ubuntu-guest-dns-lookups-failing-after-mac-host-wake-from-sleep.html'>VirtualBox Ubuntu guest DNS lookups failing after Mac host wake from sleep</a>
  </li>
  
  <li>
    <span>01 Jun 2013</span>
    &raquo;
    <a href='/2013/06/01/listing-the-files-google-drive-is-actively-syncing.html'>Showing/listing the files Google Drive is actively syncing</a>
  </li>
  
</ul>

<hr>
<div id='disqus_thread'></div>
<script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  
  var disqus_developer = 1;
  
  var disqus_shortname = 'myitcv'; // required: replace example with your forum shortname
  var disqus_identifier = 'http://blog.myitcv.org.uk/2013/06/25/finding-low-use-contacts-google-contacts-api-and-gmail-imap-meet';
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>
  Please enable JavaScript to view the
  <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a>
</noscript>
<a class='dsq-brlink' href='http://disqus.com'>
  comments powered by
  <span class='logo-disqus'>Disqus</span>
</a>


      </section>
      <footer>
        <p>
          <a href='http://www.myitcv.org.uk'>http://www.myitcv.org.uk</a>
          <br>
          <a href='mailto:paul@myitcv.org.uk'>paul@myitcv.org.uk</a>
        </p>
        <p>
          <a class='twitter icon' href='http://twitter.com/P__A__J'>Twitter</a>
          <a class='google icon' href='https://plus.google.com/u/0/105997489348527668257' rel='publisher'>Google</a>
          <a class='skype icon' href='skype:myitcv'>Skype</a>
          <a class='linkedin icon' href='http://uk.linkedin.com/in/pauljolly/'>LinkedIn</a>
          <a class='github icon' href='https://github.com/myitcv'>github</a>
          <br>
        </p>
        <p>
          <small>
            Theme by
            <a href='https://github.com/orderedlist'>orderedlist</a>
          </small>
        </p>
      </footer>
    </div>
    <script src='/javascripts/scale.fix.js'></script>
    <script>
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-38400814-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
