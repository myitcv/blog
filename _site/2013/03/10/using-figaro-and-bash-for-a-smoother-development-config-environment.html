<!doctype html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta content='chrome=1' http-equiv='X-UA-Compatible'>
    <title>Using figaro and bash for a smoother development config environment</title>
    <link href='/images/bike_favicon.png' rel='icon' type='image/png'>
    <!-- Generated 2014-02-24 16:38:29 +0000-->
    <link href='/stylesheets/styles.css' rel='stylesheet'>
    <link href='/stylesheets/pygment_trac.css' rel='stylesheet'>
    <meta content='width=device-width, initial-scale=1, user-scalable=no' name='viewport'>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class='wrapper'>
      <header>
        <div itemscope='itemscope' itemtype='http://schema.org/Blog'>
          <h1>
            <a href='/'>myitcv:blog</a>
          </h1>
        </div>
        <meta content='schema blog' itemprop='name'>
        <hr>
        <h3>Paul Jolly's blog</h3>
      </header>
      <section>
        
<div itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
  <meta content='blog.myitcv.org.uk/2013/03/10/using-figaro-and-bash-for-a-smoother-development-config-environment' itemprop='url'>
  <h1 itemprop='name'>Using figaro and bash for a smoother development config environment</h1>
  <div class='page_details'>
    <hr class='page_details'>
    <abbr class='pagedate' itemprop='datePublished' title='2013-03-10T00:00:00+00:00'>10 MAR 2013</abbr>
    <span class='author' itemprop='author' itemscope='itemscope' itemtype='http://schema.org/Person'>
      <meta content='https://plus.google.com/105997489348527668257' itemprop='url'>
      <a href='https://plus.google.com/105997489348527668257' rel='author' title='author profile'>
        <span itemprop='name'>Paul Jolly</span>
      </a>
    </span>
    <span class='location'>SAN FRANCISCO</span>
    <span class='tags'>
      <ul class='tags'>
        
        <li class='tags'>CODING</li>
        
        <li class='tags'>RUBY</li>
        
        <li class='tags'>RAILS</li>
        
      </ul>
    </span>
    <hr class='page_details'>
  </div>
  <p><em><strong>Update 2013-03-12:</strong> replaced the rather fragile piping of commands with a simple ruby script to extracting the config</em></p>

<p><em><strong>Update 2014-02-24:</strong> I have now switched to using <a href="https://github.com/cxreg/smartcd"><code>smartcd</code></a> in preference to the
aproach described below</em></p>

<hr/>

<p>Environment variables have for a long time been the source of configuration data for (many) Unix-based applications.</p>

<p><a href="https://github.com/laserlemon/figaro">Figaro</a> is a great <code>gem</code> that makes it easy to combine environment variables with
Yaml-based overrides.</p>

<blockquote>
<p>Open sourcing a Rails app can be a little tricky when it comes to sensitive configuration information like Pusher or
Stripe credentials. You don&#39;t want to check private credentials into the repo but what other choice is there?</p>

<p>Figaro provides a clean and simple way to configure your app and keep the private stuffâ€¦ private.</p>
</blockquote>

<p>Here I outline a neat method by which per project environment variables can be set using Bash to combine with the
standard figaro mode of operation.</p>

<p>We start by creating a secrets file in our <code>$HOME</code> directory, well away from any Rails projects:</p>
<div class="highlight"><pre><code class="ini language-ini" data-lang="ini"><span class="c1"># $HOME/.web_app_secrets</span>

<span class="k">[project-name]</span>
<span class="na">VAR_1</span><span class="o">=</span><span class="s">test</span>
<span class="na">VAR_2</span><span class="o">=</span><span class="s">again</span>
</code></pre></div>
<p>The format here is very simple. <code>project-name</code> should correspond to the directory which contains the Rails project in
question. For example if our Rails project is found in <code>$HOME/dev/omniauth-google-oauth2-example</code> we would be
<code>omniauth-google-oauth2-example</code> in place of <code>project-name</code>. The variable names should be <a href="http://tldp.org/LDP/Bash-Beginners-Guide/html/sect_03_02.html#sect_03_02_02">capitalised by
convention</a> .</p>

<p>Clearly this configuration file could get quite long and contain multiple sections and could contain comments:</p>
<div class="highlight"><pre><code class="ini language-ini" data-lang="ini"><span class="c1"># $HOME/.web_app_secrets</span>

<span class="c1"># comments can only be used on their own line</span>
<span class="k">[project-1-name]</span>
<span class="na">VAR_1</span><span class="o">=</span><span class="s">test</span>
<span class="na">VAR_2</span><span class="o">=</span><span class="s">again</span>

<span class="k">[project-2-name]</span>
<span class="c1"># spacing around the &#39;=&#39; is optional</span>
<span class="na">VAR_1</span>  <span class="o">=</span>  <span class="s">test</span>
<span class="c1"># it&#39;s the first non-whitespace character that counts</span>
<span class="na">VAR_2</span> <span class="o">=</span> <span class="s">first</span>

<span class="k">[project-3-name]</span>
<span class="na">VAR_1</span><span class="o">=</span><span class="s">test</span>
<span class="c1"># indeed it&#39;s everything that&#39;s after the first non-whitespace character that counts</span>
<span class="na">VAR_2</span> <span class="o">=</span> <span class="s">we want everything from this line</span>
</code></pre></div>
<p>Now let&#39;s write a helper script to pull out a named block of variables and get them in a format that bash can consume to
set environment variables:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="c1">#!/usr/bin/env ruby</span>

<span class="c1"># This file is $HOME/bin/config_select</span>
<span class="c1"># first line of the file must include the #!</span>

<span class="nb">require</span> <span class="s1">&#39;parseconfig&#39;</span>

<span class="k">raise</span> <span class="s2">&quot;Two required arguments: file group&quot;</span> <span class="k">unless</span> <span class="o">[</span><span class="mi">2</span><span class="o">].</span><span class="n">include?</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">count</span>

<span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="n">group</span><span class="p">)</span> <span class="o">=</span> <span class="no">ARGV</span>
<span class="n">config</span> <span class="o">=</span> <span class="no">ParseConfig</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
<span class="n">config</span><span class="o">[</span><span class="n">group</span><span class="o">].</span><span class="n">each_pair</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="o">&lt;&lt;-</span><span class="no">LINE</span>
<span class="sh">export #{key}=&quot;#{value}&quot;</span>
<span class="no">LINE</span>
<span class="k">end</span>
</code></pre></div>
<p>If we run this on our <code>$HOME/.web_app_secrets</code> file to pull out the <code>project-3-name</code> config:</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash"><span class="nv">$HOME</span>/bin/config_select <span class="nv">$HOME</span>/.web_app_secrets project-3-name
</code></pre></div>
<p>we get the following output as expected:</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash"><span class="nb">export </span><span class="nv">VAR_1</span><span class="o">=</span><span class="s2">&quot;test&quot;</span>
<span class="nb">export </span><span class="nv">VAR_2</span><span class="o">=</span><span class="s2">&quot;we want everything from this line&quot;</span>
</code></pre></div>
<p>Now we need to hook up Bash so that whenever we <code>cd</code> to a directory that contains a figaro-enabled project it sources
the appropriate environment variables.</p>

<p>A standard figaro installation creates a <code>config/application.yml</code> file (see the <a href="/2013/02/19/omniauth-google-oauth2-example.html">omnitauth example for
details</a>) . Hence we can test for the existence of this file in our
hook.</p>

<p>Edit <code>$HOME/.bashrc</code> to include the following (taking care if you have already aliased <code>cd</code>):</p>
<div class="highlight"><pre><code class="bash language-bash" data-lang="bash"><span class="c"># $HOME/.bashrc</span>
<span class="c"># ...</span>

<span class="nb">alias cd</span><span class="o">=</span>_cd_special

_cd_special <span class="o">()</span>
<span class="o">{</span>
  <span class="s2">&quot;cd&quot;</span> <span class="nv">$1</span>
  <span class="k">if</span> <span class="o">[</span> -e <span class="s2">&quot;$PWD/config/application.yml&quot;</span> <span class="o">]</span> <span class="c"># we are using figaro</span>
  <span class="k">then</span>
<span class="k">    </span><span class="nv">selector</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$PWD</span><span class="sb">`</span>
    <span class="nb">eval</span> <span class="k">$(</span><span class="nv">$HOME</span>/bin/config_select <span class="nv">$HOME</span>/.web_app_secrets <span class="nv">$selector</span><span class="k">)</span>
  <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># ...</span>
</code></pre></div>
<p>So how do we now use these variables in our code? Here&#39;s an example:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="c1"># config/initializers/oauth.rb</span>

<span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="no">OmniAuth</span><span class="o">::</span><span class="no">Builder</span> <span class="k">do</span>
  <span class="n">provider</span> <span class="ss">:google_oauth2</span><span class="p">,</span>
    <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;VAR_1&#39;</span><span class="o">]</span><span class="p">,</span>
    <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;VAR_2&#39;</span><span class="o">]</span><span class="p">,</span>
    <span class="p">{</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;google_login&quot;</span><span class="p">,</span> <span class="n">approval_prompt</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
<p>Furthermore, these environment variables can be overridden within the project config:</p>
<div class="highlight"><pre><code class="yaml language-yaml" data-lang="yaml"><span class="c1"># config/application.yml</span>

<span class="l-Scalar-Plain">VAR_1</span><span class="p-Indicator">:</span> <span class="s">&quot;value&quot;</span>
</code></pre></div>
<p>Notice the different style of setting values (see the <a href="http://en.wikipedia.org/wiki/YAML">Wikipedia</a> for a definitive
reference on YAML).</p>

<p>There are further benefits to using figaro when it comes to deploying to <a href="http://www.heroku.com/">Heroku</a> but this is
covered in the <a href="https://github.com/laserlemon/figaro">project&#39;s README</a></p>

</div>
<hr>
<h4>Related Posts</h4>
<ul class='posts'>
  
  <li>
    <span>25 Jun 2013</span>
    &raquo;
    <a href='/2013/06/25/finding-low-use-contacts-google-contacts-api-and-gmail-imap-meet.html'>Finding 'low use' contacts - Google Contacts API and GMail IMAP meet</a>
  </li>
  
  <li>
    <span>20 Jun 2013</span>
    &raquo;
    <a href='/2013/06/20/using-google-apis-in-rails-apps-with-oauth-2.0.html'>Using Google APIs in Rails apps with OAuth 2.0</a>
  </li>
  
  <li>
    <span>12 Jun 2013</span>
    &raquo;
    <a href='/2013/06/12/virtualbox-ubuntu-guest-dns-lookups-failing-after-mac-host-wake-from-sleep.html'>VirtualBox Ubuntu guest DNS lookups failing after Mac host wake from sleep</a>
  </li>
  
</ul>

<hr>
<div id='disqus_thread'></div>
<script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  
  var disqus_developer = 1;
  
  var disqus_shortname = 'myitcv'; // required: replace example with your forum shortname
  var disqus_identifier = 'http://blog.myitcv.org.uk/2013/03/10/using-figaro-and-bash-for-a-smoother-development-config-environment';
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>
  Please enable JavaScript to view the
  <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a>
</noscript>
<a class='dsq-brlink' href='http://disqus.com'>
  comments powered by
  <span class='logo-disqus'>Disqus</span>
</a>


      </section>
      <footer>
        <p>
          <a href='http://www.myitcv.org.uk'>http://www.myitcv.org.uk</a>
          <br>
          <a href='mailto:paul@myitcv.org.uk'>paul@myitcv.org.uk</a>
        </p>
        <p>
          <a class='twitter icon' href='http://twitter.com/P__A__J'>Twitter</a>
          <a class='google icon' href='https://plus.google.com/u/0/105997489348527668257' rel='publisher'>Google</a>
          <a class='skype icon' href='skype:myitcv'>Skype</a>
          <a class='linkedin icon' href='http://uk.linkedin.com/in/pauljolly/'>LinkedIn</a>
          <a class='github icon' href='https://github.com/myitcv'>github</a>
          <br>
        </p>
        <p>
          <small>
            Theme by
            <a href='https://github.com/orderedlist'>orderedlist</a>
          </small>
        </p>
      </footer>
    </div>
    <script src='/javascripts/scale.fix.js'></script>
    <script>
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-38400814-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
